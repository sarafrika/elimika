package apps.sarafrika.elimika.student.dto;

import apps.sarafrika.elimika.common.validation.ValidPhoneNumber;
import com.fasterxml.jackson.annotation.JsonProperty;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Student Data Transfer Object
 *
 * Represents a student profile in the Sarafrika Elimika system, extending user information
 * with student-specific data including guardian/parent contact information and academic context.
 *
 * @author Sarafrika Team
 * @version 1.0
 * @since 2024-01-01
 */
@Schema(
        name = "Student",
        description = "Student profile information including guardian contacts and academic details. Links to a base user account.",
        example = """
        {
            "uuid": "s1e2d3c4-5f6g-7h8i-9j0k-lmnopqrstuv",
            "user_uuid": "d2e6f6c4-3d44-11ee-be56-0242ac120002",
            "first_guardian_name": "John Doe",
            "first_guardian_mobile": "+254712345678",
            "second_guardian_name": "Jane Doe",
            "second_guardian_mobile": "+254787654321",
            "created_date": "2024-04-01T12:00:00",
            "created_by": "admin@sarafrika.com",
            "updated_date": "2024-04-15T15:30:00",
            "updated_by": "admin@sarafrika.com"
        }
        """
)
public record StudentDTO(

        @Schema(
                description = "**[READ-ONLY]** Unique system identifier for the student profile. Auto-generated by the system.",
                example = "s1e2d3c4-5f6g-7h8i-9j0k-lmnopqrstuv",
                accessMode = Schema.AccessMode.READ_ONLY,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @JsonProperty(value = "uuid", access = JsonProperty.Access.READ_ONLY)
        UUID uuid,

        @Schema(
                description = "**[REQUIRED]** Reference to the base user account UUID. Links student profile to user authentication and personal details.",
                example = "d2e6f6c4-3d44-11ee-be56-0242ac120002",
                requiredMode = Schema.RequiredMode.REQUIRED
        )
        @NotNull(message = "User UUID is required")
        @JsonProperty("user_uuid")
        UUID userUuid,

        @Schema(
                description = "**[OPTIONAL]** Full name of the primary guardian/parent. This is the main emergency contact for the student.",
                example = "John Doe",
                minLength = 1,
                maxLength = 100,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @Size(max = 100, message = "First guardian name must not exceed 100 characters")
        @JsonProperty("first_guardian_name")
        String firstGuardianName,

        @Schema(
                description = "**[OPTIONAL]** Mobile phone number of the primary guardian. Used for emergency contacts and notifications. Should include country code.",
                example = "+254712345678",
                minLength = 1,
                maxLength = 20,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @Size(max = 20, message = "First guardian mobile must not exceed 20 characters")
        @JsonProperty("first_guardian_mobile")
        @ValidPhoneNumber(mobileOnly = true)
        String firstGuardianMobile,

        @Schema(
                description = "**[OPTIONAL]** Full name of the secondary guardian/parent. Additional emergency contact for the student.",
                example = "Jane Doe",
                maxLength = 100,
                nullable = true,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @Size(max = 100, message = "Second guardian name must not exceed 100 characters")
        @JsonProperty("second_guardian_name")
        String secondGuardianName,

        @Schema(
                description = "**[OPTIONAL]** Mobile phone number of the secondary guardian. Alternative contact for emergencies and notifications. Should include country code.",
                example = "+254787654321",
                maxLength = 20,
                nullable = true,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @Size(max = 20, message = "Second guardian mobile must not exceed 20 characters")
        @JsonProperty("second_guardian_mobile")
        @ValidPhoneNumber(mobileOnly = true)
        String secondGuardianMobile,

        @Schema(
                description = "**[READ-ONLY]** Timestamp when the student profile was first created. Automatically set by the system.",
                example = "2024-04-01T12:00:00",
                format = "date-time",
                accessMode = Schema.AccessMode.READ_ONLY,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @JsonProperty(value = "created_date", access = JsonProperty.Access.READ_ONLY)
        LocalDateTime createdDate,

        @Schema(
                description = "**[READ-ONLY]** Email or username of the user who created this student profile. Used for audit trails.",
                example = "admin@sarafrika.com",
                accessMode = Schema.AccessMode.READ_ONLY,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @JsonProperty(value = "created_by", access = JsonProperty.Access.READ_ONLY)
        String createdBy,

        @Schema(
                description = "**[READ-ONLY]** Timestamp when the student profile was last modified. Automatically updated by the system on any changes.",
                example = "2024-04-15T15:30:00",
                format = "date-time",
                accessMode = Schema.AccessMode.READ_ONLY,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @JsonProperty(value = "updated_date", access = JsonProperty.Access.READ_ONLY)
        LocalDateTime updatedDate,

        @Schema(
                description = "**[READ-ONLY]** Email or username of the user who last modified this student profile. Used for audit trails.",
                example = "admin@sarafrika.com",
                accessMode = Schema.AccessMode.READ_ONLY,
                requiredMode = Schema.RequiredMode.NOT_REQUIRED
        )
        @JsonProperty(value = "updated_by", access = JsonProperty.Access.READ_ONLY)
        String updatedBy

) {

    /**
     * Checks if the student has a secondary guardian configured.
     *
     * @return true if second guardian name and mobile are both provided, false otherwise
     */
    public boolean hasSecondaryGuardian() {
        return secondGuardianName != null && !secondGuardianName.trim().isEmpty() &&
                secondGuardianMobile != null && !secondGuardianMobile.trim().isEmpty();
    }

    /**
     * Returns the primary guardian's contact information as a formatted string.
     *
     * @return Formatted string with guardian name and mobile number
     */
    public String getPrimaryGuardianContact() {
        return firstGuardianName + " (" + firstGuardianMobile + ")";
    }

    /**
     * Returns the secondary guardian's contact information as a formatted string.
     *
     * @return Formatted string with guardian name and mobile number, or null if no secondary guardian
     */
    public String getSecondaryGuardianContact() {
        if (!hasSecondaryGuardian()) {
            return null;
        }
        return secondGuardianName + " (" + secondGuardianMobile + ")";
    }

    /**
     * Returns all guardian contact information as a formatted list.
     *
     * @return Array of guardian contact strings
     */
    public String[] getAllGuardianContacts() {
        if (hasSecondaryGuardian()) {
            return new String[]{getPrimaryGuardianContact(), getSecondaryGuardianContact()};
        }
        return new String[]{getPrimaryGuardianContact()};
    }
}