# Commerce Checkout & Enrollment Paywall Guide

## 1. Overview

This guide walks frontend engineers and designers through the end-to-end experience of purchasing course/class access and enrolling students once payment is confirmed. It covers the required API calls, payload structure, and UI states you should support to keep the learner flow aligned with the backend paywall.

- **Cart API Root:** `/api/v1/commerce/carts`
- **Order API Root:** `/api/v1/commerce/orders`
- **Enrollment API Root:** `/api/v1/enrollment`
- **Error Code For Unpaid Access:** `402 Payment Required`

---

## 2. Experience Flow

1. Create cart (`POST /commerce/carts`) with `currency_code` and optional `region_code`.
2. Add items (`POST /commerce/carts/{id}/items`) with variant and quantity only; the backend enriches metadata automatically from the catalogue.
3. Select payment provider (`POST /commerce/carts/{id}/payment-session`).
4. Checkout (`POST /commerce/orders/checkout`).
5. On payment success, attempt enrollment; paywall returns `402` if unpaid.

---

## 3. API Call Sequence

Sequence (text):
- UI → Cart API: create cart; receive `id`, totals.
- UI → Cart API: add items (variant + quantity only); receive updated cart with system metadata for catalogue context.
- UI → Cart API: select payment provider.
- UI → Order API: checkout with cart id, customer email, provider; wait for paid status.
- UI → Enrollment API: enroll class/student; handle `402` for unpaid.

---

## 4. Order Placement Sequence (Detailed)

Use the following ordered steps in your UI to ensure cart and checkout interactions stay aligned with backend expectations:

1. **Bootstrap Cart**  
   `POST /api/v1/commerce/carts` with `currency_code` (and optional `region_code`) to receive a `cart.id`.
2. **Add Line Items**  
   For each course/class selection call `POST /api/v1/commerce/carts/{cartId}/items` with `variant_id` and `quantity`. The backend attaches read-only catalogue metadata to the cart items for you.
3. **Review / Edit Cart** *(optional)*  
   Fetch the cart via `GET /api/v1/commerce/carts/{cartId}` if you need to render a confirmation page or allow removals.
4. **Lock Payment Provider**  
   `POST /api/v1/commerce/carts/{cartId}/payment-session` with `provider_id` to prepare the payment session.
5. **Collect Payer Details**  
   Gather email (and address IDs if relevant) for the final checkout payload.
6. **Complete Checkout**  
   `POST /api/v1/commerce/orders/checkout` with the cart ID, payer email, and provider. Wait for `payment_status` to be `captured` or `paid` before moving forward.
7. **Display Order Summary**  
   Show the order identifier/number from the response and surface a “Continue to enrollment” CTA.
8. **Attempt Enrollment**  
   Call `POST /api/v1/enrollment` with `class_definition_uuid` and `student_uuid` only after confirming payment. The backend will enroll the learner into every scheduled instance for that class. Handle `402` responses as described later in this guide.

---

## 5. System-Managed Cart Metadata

Cart and line item metadata is now generated by the backend from catalogue and inventory models. Clients should send only `variant_id` and `quantity` when adding items; metadata in responses is read-only and reflects non-sensitive course/class context.

### What the backend returns per line item

- `product_uuid` – Internal commerce product backing the SKU.
- `course_uuid` – Course tied to the product (if present).
- `class_definition_uuid` – Class template/cohort for scheduled sessions (if present).
- `variant_uuid` / `variant_code` – Identifiers for the purchasable SKU.
- `product_title` / `variant_title` – Human-friendly labels for display.

Use the catalogue endpoints (`/api/v1/commerce/catalogue/...`) to resolve the correct `variant_id`; the backend will derive the rest.

### Example Add-Item Request

```json
{
  "variant_id": "variant_01HZX1Y4K8R0HVWZ4Q6CF6M1AP",
  "quantity": 1
}
```

### Example Item Shape In Cart/Order Responses

```json
{
  "id": "line-item-uuid",
  "variant_id": "class-definition-uuid",
  "quantity": 1,
  "metadata": {
    "product_uuid": "product-uuid",
    "product_title": "Advanced Excel Course",
    "course_uuid": "course-uuid",
    "class_definition_uuid": "class-definition-uuid",
    "variant_uuid": "variant-uuid",
    "variant_code": "class-definition-uuid",
    "variant_title": "Advanced Excel"
  }
}
```

---

## 6. Checkout Steps & UI Checklist

1. **Create Cart** – Call `POST /commerce/carts` when the learner begins checkout. Store `cart.id`.
2. **Add Items** – Each course/class combination becomes an item; the backend attaches catalogue metadata automatically.
3. **Review Cart** – Render cart items from the response and allow removal or quantity changes (if supported).
4. **Select Payment Provider** – `POST /commerce/carts/{cartId}/payment-session` uses the provider (e.g., `manual`, `mpesa`).
5. **Collect Payer Details** – Capture `customer_email` (and addresses if applicable).
6. **Complete Checkout** – `POST /commerce/orders/checkout` finalizes the order. Inspect `payment_status` (`captured`/`paid`) to mark success.
7. **Store Order Reference** – Use `order.id` or `order.display_id` for receipts and reconciliation.
8. **Advance to Enrollment UX** – Present “Continue to enrollment” CTA after payment.
9. **Email Receipt** – The backend now emits an order receipt email to the purchaser using the checkout context and order totals; surface the same summary in the UI for consistency.

---

## 7. Handling Paywall Errors (HTTP 402)

When the frontend calls `POST /enrollment`, the backend verifies payment. If there is no matching paid purchase, you will receive:

```json
{
  "success": false,
  "message": "Class fee must be settled before enrollment is permitted.",
  "error": {
    "timestamp": "2025-10-10T05:40:00Z"
  }
}
```

### Age-gated enrollments
- After payment succeeds but before the class is reserved, the enrollment API checks the course/class age limits via `AgeVerificationService`. If the student’s DOB is missing or outside the allowed band, the endpoint returns `422` with an `AgeRestrictionException` message (e.g., “Student age 12 is below the minimum age 16 required for course ‘Algebra Basics’”).
- Require learners or guardians to supply DOB before checkout, store it in the student profile, and surface the backend message verbatim so families understand why the enrollment cannot proceed. Offer alternate classes or refund paths when appropriate.

### UI Guidance

- **Primary CTA:** “Complete payment to enroll.”
- **Secondary CTA:** “Review Cart & Payment History” linking to the order summary UI.
- **Contextual messaging:** show course/class name and student name involved.

---

## 8. Enrollment UI States

| State                 | Trigger                                               | Suggested UI Treatment                                                |
|-----------------------|-------------------------------------------------------|------------------------------------------------------------------------|
| Pending Payment       | 402 response from paywall                             | Display paywall card with CTA to reopen checkout.                     |
| Payment in Progress   | Checkout request sent, waiting on provider confirmation | Disable enrollment button, show spinner & “Verifying payment…” copy. |
| Enrollment Confirmed  | Enrollment API success                                | Show success toast + redirect to class dashboard/schedule.            |
| Enrollment Conflict   | 400/409 from scheduling (capacity or double-booking)  | Reuse existing scheduling conflict patterns.                          |

---

## 9. Reference API Payloads

### Create Cart

```http
POST /api/v1/commerce/carts
Content-Type: application/json
{
  "currency_code": "USD",
  "region_code": "KE",
  "items": []
}
```

### Checkout

```http
POST /api/v1/commerce/orders/checkout
Content-Type: application/json
{
  "cart_id": "2f6d4d1e-5f2a-4b2e-9f8d-0b7c3e9b5c1a",
  "customer_email": "learner@example.com",
  "payment_provider_id": "manual"
}
```

### Enrollment Attempt

```http
POST /api/v1/enrollment
Content-Type: application/json
{
  "class_definition_uuid": "0a39e4fa-0e97-4fd2-94ab-09bd4a67c676",
  "student_uuid": "8f4544d3-1741-47ba-aacc-5c9e0fbcd410"
}
```

---

## 10. Design Considerations

- **Cart Summary Card:** include course title, class schedule, learner name, and price so the paywall can reference it later.
- **Order Receipt View:** show payment status badge (`Paid`, `Pending`, `Failed`). Provide “Enroll Now” CTA only when status is a success state.
- **Error State Illustration:** differentiate paywall failures from scheduling conflicts to guide the learner appropriately.
- **Mobile Flow:** ensure cart and enrollment steps can be completed in separate sessions; persistence of `cart_id` and `order_id` is crucial.

---

## 11. QA Checklist

- [ ] Cart responses include system-provided line item metadata (course/class context) and the UI treats it as read-only.
- [ ] Payment status from `OrderResponse` is displayed in the UI receipt.
- [ ] Enrollment attempts after payment succeed without manual refresh.
- [ ] Unpaid enrollment attempts render the 402 paywall state.
- [ ] Parents/admins purchasing on behalf of a student use the correct `student_uuid`.

Following this guide keeps the user journey consistent with the backend paywall and ensures learners only access classes once their payments are confirmed.
